services:
  - type: web
    name: passive-captcha
    env: python
    buildCommand: |
      echo "🏗️ Building Passive CAPTCHA for Render..."
      echo "📦 Installing Node.js dependencies..."
      cd frontend && npm install --no-audit --no-fund
      echo "🔨 Building frontend..."
      npm run build
      echo "📂 Verifying frontend build..."
      ls -la dist/
      echo "📄 Checking index.html..."
      ls -la dist/index.html
      echo "📁 Checking assets folder..."
      ls -la dist/assets/ || echo "No assets folder found"
      echo "📂 Copying frontend to backend static folder..."
      cd ..
      mkdir -p backend/static
      cp -r frontend/dist/* backend/static/
      echo "✅ Verifying copied files..."
      ls -la backend/static/
      echo "📄 Checking copied index.html..."
      ls -la backend/static/index.html
      echo "📁 Checking copied assets..."
      ls -la backend/static/assets/ || echo "No assets folder copied"
      echo "🐍 Installing Python dependencies..."
      pip install -r backend/requirements-render.txt
      echo "✅ Build completed successfully!"
    startCommand: "cd backend && python main.py --host 0.0.0.0 --port $PORT"
    plan: free
    runtime: python3.11
    envVars:
      - key: FLASK_ENV
        value: production
      - key: ADMIN_SECRET
        value: Admin123
      - key: JWT_SECRET_KEY
        value: jwt-secret-key-for-passive-captcha-production-environment-render
      - key: SECRET_KEY
        value: passive-captcha-production-secret-key-ultra-secure-32-chars-minimum-render
      - key: HOST
        value: 0.0.0.0
      - key: PORT
        fromGroup: 5003
      - key: RENDER_EXTERNAL_URL
        value: https://passive-captcha.onrender.com
      - key: ALLOWED_ORIGINS
        value: https://passive-captcha.onrender.com,http://localhost:3000,*
      - key: API_BASE_URL
        value: https://passive-captcha.onrender.com
      - key: WEBSOCKET_URL
        value: wss://passive-captcha.onrender.com
      - key: DATABASE_URL
        value: sqlite:///passive_captcha_production.db
      - key: REDIS_URL
        value: redis://localhost:6379/0
      - key: CONFIDENCE_THRESHOLD
        value: "0.6"
      - key: LOG_LEVEL
        value: INFO
      - key: ENABLE_REAL_TIME_LOGS
        value: "true"
      - key: ENABLE_ML_MONITORING
        value: "true"
      - key: SESSION_COOKIE_SECURE
        value: "true"
      - key: NODE_VERSION
        value: "18"
    healthCheckPath: /health